#cloud-config

chpasswd:
  list: |
    root:r00tme
    ubuntu:ubuntu
  expire: False
ssh_pwauth: True
disable_root: False
ssh_authorized_keys:{% for key in ssh_authorized_keys %}
 - {{ key }}{% endfor %}

bootcmd:
 - echo 'LABEL=MOREVM none swap sw 0 0' >> /etc/fstab
 - swapon -a || true

apt_sources:
 - source: deb http://asheplyakov.srt.mirantis.net/Public/repos/ceph {{ ceph_release }}-{{ distro_release }} main
   filename: ceph.list

add_apt_repo_match: '^[\w-]+:\w'

apt_proxy: {{ http_proxy }}

write_files:
 - path: /etc/hosts
   permissions: '0644'
   content: |
     127.0.0.1 localhost
 - path: /etc/apt/sources.list
   permissions: '0644'
   content: |
     deb http://ru.archive.ubuntu.com/ubuntu {{ distro_release }} main universe multiverse restricted
     deb http://ru.archive.ubuntu.com/ubuntu {{ distro_release }}-updates  main universe multiverse restricted
     deb http://ru.archive.ubuntu.com/ubuntu {{ distro_release }}-security main universe multiverse restricted
 - path: /etc/apt/preferences.d/ceph.pref
   permissions: '0644'
   content: |
     Package: *
     Pin: release l=sa-{{ ceph_release }}-{{ distro_release }}
     Pin-Priority: 1050
 - path: /etc/apt/apt.conf.d/90_allow_unsigned_repos
   permissions: '0644'
   content: |
     APT::Get::AllowUnauthenticated "1";
 - path: /etc/init/ttyS0.conf
   permissions: '0644'
   content: |
     # login prompt on serial console
     start on stopped rc RUNLEVEL=[2345]
     stop on RUNLEVEL [!12345]
     respawn
     exec /sbin/getty -L 115200 ttyS0 vt102
 - path: /usr/local/sbin/zap-ceph-disks
   permissions: '0755'
   content: |
     #!/bin/sh
     for disk in /dev/disk/by-id/*_DATA /dev/disk/by-id/*_JOURNAL; do
            dd if=/dev/zero of="$disk" bs=1M count=32 conv=fsync
            parted --script "$disk" mklabel gpt
            blockdev --rereadpt "$disk"
     done


apt_preserve_sources_list: True

runcmd:
 - mkdir -m755 -p /media/work
 - "echo 'debconf debconf/priority select critical' | debconf-set-selections"
 - "echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections"
 - apt-get update
 - apt-get dist-upgrade -y
 - apt-get install -y haveged nfs-common gdbserver vim-nox ceph parted
 - "echo 'sahost:/home/asheplyakov/work /media/work nfs rw,tcp,hard,noatime,_netdev 0 0' >> /etc/fstab"
 - dpkg --configure -a
 - /usr/local/sbin/zap-ceph-disks
 - "apt-get purge -y cloud-init"

phone_home:
  url: {{ web_callback_url }}
  post: [ hostname, pub_key_rsa ]

power_state:
  mode: reboot
  message: Rebooting
  condition: True
